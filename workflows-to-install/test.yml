name: Flutter Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  FLUTTER_VERSION: '3.24.5'

jobs:
  test:
    name: Run Tests & Check Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Cache pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            **/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Install dependencies
        run: flutter pub get

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Check formatting
        run: |
          echo "Checking code formatting..."
          dart format --set-exit-if-changed .

      - name: Analyze project source
        run: |
          echo "Running static analysis..."
          flutter analyze

      - name: Run tests with coverage
        run: |
          echo "Running tests with coverage..."
          flutter test --coverage

      - name: Check coverage threshold
        run: |
          echo "Checking coverage threshold..."

          # Install lcov if not available
          if ! command -v lcov &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y lcov
          fi

          # Get coverage percentage
          COVERAGE=$(lcov --summary coverage/lcov.info 2>&1 | grep -oP 'lines......: \K[0-9.]+')
          echo "Current coverage: $COVERAGE%"

          # Check if coverage meets threshold (80%)
          THRESHOLD=80.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "âŒ Coverage $COVERAGE% is below threshold $THRESHOLD%!"
            exit 1
          else
            echo "âœ… Coverage $COVERAGE% meets threshold $THRESHOLD%"
          fi

      - name: Generate HTML coverage report
        if: always()
        run: |
          if command -v genhtml &> /dev/null; then
            genhtml coverage/lcov.info -o coverage/html
          else
            echo "genhtml not available, skipping HTML report generation"
          fi

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const lcovFile = 'coverage/lcov.info';

            if (!fs.existsSync(lcovFile)) {
              console.log('Coverage file not found');
              return;
            }

            // Read coverage file
            const { execSync } = require('child_process');
            let coverage = '0.0';
            try {
              const summary = execSync('lcov --summary coverage/lcov.info 2>&1', { encoding: 'utf8' });
              const match = summary.match(/lines......: ([\d.]+)%/);
              if (match) coverage = match[1];
            } catch (e) {
              console.log('Could not parse coverage');
            }

            const threshold = 80.0;
            const emoji = parseFloat(coverage) >= threshold ? 'âœ…' : 'âŒ';

            const comment = `## ${emoji} Test Coverage Report

            **Coverage**: ${coverage}%
            **Threshold**: ${threshold}%
            **Status**: ${parseFloat(coverage) >= threshold ? 'PASSING' : 'FAILING'}

            ${parseFloat(coverage) < threshold ? 'âš ï¸ Coverage is below the required threshold!' : 'ðŸŽ‰ Great job maintaining test coverage!'}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Quality gate summary
  quality-gate:
    name: Quality Gate
    needs: test
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check quality gate
        run: |
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… Quality gate PASSED"
            echo "All checks passed: formatting, analysis, tests, and coverage"
          else
            echo "âŒ Quality gate FAILED"
            echo "One or more checks failed"
            exit 1
          fi
